<!DOCTYPE html>
<html>
<link>
    <title>Hello WebSocket</title>
    <link type="text/css" rel="stylesheet" href="/css/style.css" />
    <script src="js/sockjs-0.3.4.js"></script>
    <script src="js/stomp.js"></script>
    <script src="js/jquery-2.1.4.min.js"></script>
    <script src="js/jquery.transit.min.js"></script>
    <script type="text/javascript">

        var sudokuSocket = Stomp.over(new SockJS('/sockjsendpoint'));

        sudokuSocket.connect({},function(frame) {

            var username = frame.headers['user-name'];

            console.log('Connected: ' + frame);
            sudokuSocket.subscribe('/topic/game/login', function (message) {
                console.log(message);
            });
            sudokuSocket.subscribe('/app/game/players', function (message) {
                updateConnectedPlayers(JSON.parse(message.body));
            });
            sudokuSocket.subscribe('/topic/game/start', function (message) {
                initBoard(JSON.parse(message.body));
            });
            sudokuSocket.subscribe('/topic/game/update', function (message) {
                console.log(message);
            });
            sudokuSocket.subscribe('/user/queue/attempt', function (message) {
                console.log(message);
                updateAttempt(JSON.parse(message.body));
            });
        }, function(error) {
            console.error('Error:' + error);
        });

        function initBoard(board) {
            for (var x = 0; x < board.length; x++) {
                for (var y = 0; y < board[0].length; y++) {
                    if (board[x][y] != 0) {
                        setFieldValue(x, y, board[x][y]);
                    }
                }
            }
        }

        function updateAttempt(gameUpdate) {
            var fieldInput = getFieldInput(gameUpdate.x, gameUpdate.y);
            setValueOnField(fieldInput, gameUpdate.value);
            $(fieldInput).transition({"background-color": "green"})
            			.transition({"background-color": "white"});
            
        }

        function getFieldInput(x, y) {
			return $('input[data-x=' + x + '][data-y=' + y + ']')[0];
        }

        function setFieldValue(x, y, value) {
            getFieldInput(x,y).value = value;
        }

        function setValueOnField(fieldInput, value) {
            fieldInput.value = value;
        }

        function updateConnectedPlayers(players) {
            $('#playerList').empty();
            players.forEach(function(player) {
                $('#playerList').append($('<li>' + player.playerName + '</li>'));
            });
        }

        function setupInputHandler() {
            $('input').on('input', function (element) {
                if (this.value.length > 1) {
                    this.value = this.value.slice(0,1);
                }
                var x = $(this).attr("data-x");
                var y = $(this).attr("data-y");
                sudokuSocket.send("/app/solve", {}, JSON.stringify({x: x, y: y, value: this.value}));
            });
        }
    </script>
</head>

<body onload="setupInputHandler();">

<div>
    <div>
        <h2>Connected Players</h2>
        <div id="players">
            <ul id="playerList">

            </ul>
        </div>
    </div>
    <div>
        <table>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="0" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="0" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="0" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="0" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="0" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="0" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="0" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="0" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="0" /> </td>
            </tr>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="1" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="1" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="1" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="1" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="1" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="1" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="1" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="1" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="1" /> </td>
            </tr>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="2" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="2" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="2" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="2" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="2" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="2" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="2" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="2" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="2" /> </td>
            </tr>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="3" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="3" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="3" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="3" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="3" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="3" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="3" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="3" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="3" /> </td>
            </tr>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="4" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="4" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="4" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="4" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="4" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="4" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="4" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="4" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="4" /> </td>
            </tr>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="5" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="5" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="5" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="5" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="5" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="5" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="5" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="5" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="5" /> </td>
            </tr>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="6" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="6" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="6" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="6" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="6" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="6" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="6" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="6" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="6" /> </td>
            </tr>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="7" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="7" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="7" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="7" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="7" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="7" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="7" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="7" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="7" /> </td>
            </tr>
            <tr>
                <td> <input type="number" min="1" max="9" data-x="0" data-y="8" /> </td>
                <td> <input type="number" min="1" max="9" data-x="1" data-y="8" /> </td>
                <td> <input type="number" min="1" max="9" data-x="2" data-y="8" /> </td>
                <td> <input type="number" min="1" max="9" data-x="3" data-y="8" /> </td>
                <td> <input type="number" min="1" max="9" data-x="4" data-y="8" /> </td>
                <td> <input type="number" min="1" max="9" data-x="5" data-y="8" /> </td>
                <td> <input type="number" min="1" max="9" data-x="6" data-y="8" /> </td>
                <td> <input type="number" min="1" max="9" data-x="7" data-y="8" /> </td>
                <td> <input type="number" min="1" max="9" data-x="8" data-y="8" /> </td>
            </tr>
        </table>
    </div>
</div>

</body>
</html>